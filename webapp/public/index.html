<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion NAS et Commandes</title>
</head>

<body>
    <h1>Gestion du NAS et des analyses</h1>

    <!-- Network path form section -->
    <form id="network-path-form">
        <label for="network-path">Chemin du partage NAS :</label>
        <input type="text" id="network-path" name="path">
        <button type="submit">Monter le partage NAS</button>
    </form>

    <!-- Buttons for different operations -->
    <button id="mpc-update-button">Mise à jour MPC</button>
    <button id="blissify-init-button">Blissify Init</button>
    <button id="blissify-update-button">Blissify Update</button>

    <!-- Container for output messages -->
    <pre id="console-output"></pre>

    <script>
        // Function to display the last two lines of output in the dedicated container
        function displayOutput(data) {
            const outputElement = document.getElementById('console-output');
            const currentContent = outputElement.innerText.split('\n');

            // Ajouter la nouvelle ligne reçue
            currentContent.push(data.trim());

            // Garder uniquement les deux dernières lignes
            const updatedContent = currentContent.slice(-2).join('\n');

            // Mettre à jour le contenu de <pre>
            outputElement.innerText = updatedContent;
        }

        // Event listeners for operations
        document.getElementById('network-path-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const networkPath = document.getElementById('network-path').value;

            // Mount the NAS share
            fetch(`/mount-nas?path=${encodeURIComponent(networkPath)}`)
                .then(response => response.text())
                .then(displayOutput)
                .catch(error => {
                    displayOutput(`Erreur lors du montage : ${error}`);
                });
        });

        // MPC update after mounting
        document.getElementById('mpc-update-button').addEventListener('click', function () {
            fetch('/mpc-update')
                .then(response => response.text())
                .then(displayOutput)
                .catch(error => {
                    displayOutput(`Erreur lors de la mise à jour MPC : ${error}`);
                });
        });

        // Trigger blissify init
        document.getElementById('blissify-init-button').addEventListener('click', function () {
            const eventSource = new EventSource('/start-analysis');

            eventSource.onmessage = function (event) {
                // Mettre à jour uniquement les deux dernières lignes
                displayOutput(event.data);
            };

            eventSource.onerror = function (event) {
                displayOutput(`Erreur : ${event.data}`);
                eventSource.close(); // Fermer la connexion SSE en cas d'erreur
            };
        });

        // Trigger blissify update
        document.getElementById('blissify-update-button').addEventListener('click', function () {
            fetch('/blissify-update')
                .then(response => response.text())
                .then(displayOutput)
                .catch(error => {
                    displayOutput(`Erreur lors de la mise à jour Blissify : ${error}`);
                });
        });
    </script>
</body>

</html>
